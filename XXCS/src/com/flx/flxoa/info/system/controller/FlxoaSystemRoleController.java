package com.flx.flxoa.info.system.controller;

import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.json.JSONArray;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.ModelMap;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;

import com.flx.flxoa.common.util.DateUtils;
import com.flx.flxoa.info.projectmanagement.entity.FlxoaProjectBidRecord;
import com.flx.flxoa.info.projectmanagement.entity.FlxoaProjectInformation;
import com.flx.flxoa.info.system.entity.FlxoaSystemDepartment;
import com.flx.flxoa.info.system.entity.FlxoaSystemRole;
import com.flx.flxoa.info.system.entity.FlxoaSystemRoleFuncation;
import com.flx.flxoa.info.system.entity.FlxoaSystemUserRole;
import com.flx.flxoa.info.system.manager.FlxoaSystemRoleFuncationService;
import com.flx.flxoa.info.system.manager.FlxoaSystemRoleService;

/**
 * @author 雷君
 * @version 创建时间：2018-3-28 上午9:22:28
 * 类说明  	角色管理
 */
@Controller
public class FlxoaSystemRoleController {
	protected  FlxoaSystemRoleService flxoaSystemRoleService;
	protected  FlxoaSystemRoleFuncationService flxoaSystemRoleFuncationService;
	@Autowired
	public void setSystemRoleService(FlxoaSystemRoleService flxoaSystemRoleService) {
		this.flxoaSystemRoleService = flxoaSystemRoleService;
	}
	
	@Autowired
	public void setSystemRoleFuncationService(FlxoaSystemRoleFuncationService flxoaSystemRoleFuncationService) {
		this.flxoaSystemRoleFuncationService = flxoaSystemRoleFuncationService;
	}
	
	
	@RequestMapping(value = "rolelist")
	public String projectList(HttpServletRequest request,HttpServletResponse response, ModelMap model) {
		
		return "nk/pages/system/roleManage";
	}
	/**
	 * @param 
	 * @param response
	 * @param model
	 * @return 添加角色及功能权限管理
	 */
	@RequestMapping(value = "/flxoaSystemRoleAdd", produces = "text/html;charset=utf-8")
	@ResponseBody
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   	/*@RequestParam(value = "funcationIds[]" ) Integer funcationIds, */
	public String flxoaSystemRoleAdd(HttpServletRequest request,
			HttpServletResponse response,@RequestParam(value = "role_funct[]") Integer[] role_funct, FlxoaSystemRole model) {
		String roleName = request.getParameter("roleName");
		String result = "0";
		//查询角色信息true或alse
		boolean rolename = flxoaSystemRoleService.isExist(roleName);
		if(rolename){
			/**
			 * 添加角色开始
			 */
			//FlxoaSystemRole实体
			FlxoaSystemRole role = new FlxoaSystemRole();
			//角色名称
			role.setName(roleName);
			//未删除 0  已删除1
			role.setDeleteFlag("0");
			boolean b = flxoaSystemRoleService.add(role);
			/**
			 * 添加角色结束
			 */
			//给当前角色添加功能
			if(null != role_funct){
				FlxoaSystemRole flxoaSystemRole = new FlxoaSystemRole();
				flxoaSystemRole.setName(roleName);
				List<FlxoaSystemRole> departmentdata = flxoaSystemRoleService.query(flxoaSystemRole);
				for(int i = 0; i < role_funct.length; i ++ ){
					//FlxoaSystemRoleFuncation实体
					FlxoaSystemRoleFuncation  roleFuncation =new FlxoaSystemRoleFuncation();
					roleFuncation.setRoleId(role.getId());
					System.out.println("role.getId()="+role.getId());
					//未删除 0  已删除
					roleFuncation.setDeleteFlag("0");
					//功能ID
					roleFuncation.setFuncationId(role_funct[i]);                                 
					boolean bFuncation = flxoaSystemRoleFuncationService.add(roleFuncation);
					if(bFuncation){
						result = "1";
					}
				}
			}
		}else {
			result = "3";
		}
		return result;
	}
	
	/**
	 * @param 
	 * @param response
	 * @param model
	 * @return 修改角色及功能权限管理
	 */
	@RequestMapping(value = "/flxoaSystemRoleUpdata", produces = "text/html;charset=utf-8")
	@ResponseBody
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   	/*@RequestParam(value = "funcationIds[]" ) Integer funcationIds, */
	public String flxoaSystemRoleUpdata(HttpServletRequest request,
			HttpServletResponse response,@RequestParam(value = "role_funct[]") Integer[] role_funct, FlxoaSystemRole model) {
		String roleName = request.getParameter("roleName");
		String result = "0";
		/**
		 * 修改角色开始
		 */
		//FlxoaSystemRole实体
		FlxoaSystemRole flxoaSystemRole = new FlxoaSystemRole();
		flxoaSystemRole.setId(Integer.valueOf(request.getParameter("roleid")));
		FlxoaSystemRole flxoaRole = flxoaSystemRoleService.queryById(flxoaSystemRole);
		//角色名称
		flxoaRole.setName(roleName);
		boolean b = flxoaSystemRoleService.update(flxoaRole);
		/**
		 * 更新角色结束
		 */
		//FlxoaSystemRoleFuncation实体
		FlxoaSystemRoleFuncation  roleFuncation =new FlxoaSystemRoleFuncation();
		roleFuncation.setRoleId(Integer.valueOf(request.getParameter("roleid")));
		boolean r = flxoaSystemRoleFuncationService.deleteByName(roleFuncation);
		//给当前角色添加功能
		if(null != role_funct){
			for(int i = 0; i < role_funct.length; i ++ ){
					FlxoaSystemRoleFuncation  roleFuncation1 =new FlxoaSystemRoleFuncation();
					roleFuncation1.setRoleId(flxoaRole.getId());
					//未删除 0  已删除
					roleFuncation1.setDeleteFlag("0");
					//功能ID
					roleFuncation1.setFuncationId(role_funct[i]);                                 
					boolean bFuncation = flxoaSystemRoleFuncationService.add(roleFuncation1);
					if(bFuncation){
						result = "1";
					}
			}
		}
		return result;
	}
	/**
	 * @param request
	 * @param response
	 * @param model
	 * @return 角色信息
	 */
	@RequestMapping(value = "/flxoaSystemRoleInif", produces = "text/html;charset=utf-8")
	@ResponseBody
	public String  flxoaSystemRoleInif(HttpServletRequest request,
			HttpServletResponse response, FlxoaSystemRole model){
				JSONArray json = new JSONArray();
				String pageNo = request.getParameter("pageNo");
				String pageSize = request.getParameter("pageSize");
				if (pageNo == "" || pageNo == null) {
					pageNo = "1";
				}
				if (pageSize == "" || pageSize == null) {
					pageSize = "100";
				}
				model.setName(request.getParameter("role_name"));
				// newMap集合存放返回前台页面的json
				Map<String, List> map = new HashMap<String, List>();
				// 求项目阶各阶段总和
				List<FlxoaSystemRole> role = flxoaSystemRoleService.queryForPage(Integer.valueOf(pageNo),Integer.valueOf(pageSize),model);
				map.put("rolemessage", role);
				JSONArray jsonMap = json.put(map);
				return json.toString();
	}
	
	
	
	/**
	 * @param request
	 * @param response
	 * @param model
	 * @return 查看
	 */
	@RequestMapping(value = "/flxoaSystemRoleSee", produces = "text/html;charset=utf-8")
	@ResponseBody
	public String  flxoaSystemRoleSee(HttpServletRequest request,
			HttpServletResponse response, FlxoaSystemRole model){
		model.setRoid(request.getParameter("roid"));
		JSONArray json = new JSONArray();
		// newMap集合存放返回前台页面的json
		Map<String, List> map = new HashMap<String, List>();
		List<FlxoaSystemRole> role = flxoaSystemRoleService.query(model);
		map.put("rolefunmessage", role);
		JSONArray jsonMap = json.put(map);
		return json.toString();
	}
	
	
	/**
	 * @param request
	 * @param response
	 * @param model
	 * @return 删除
	 */
	@RequestMapping(value = "/flxoaSystemRoleDelete", produces = "text/html;charset=utf-8")
	@ResponseBody
	public String flxoaSystemRoleDelete(HttpServletRequest request,
			HttpServletResponse response, FlxoaSystemRole model){
		FlxoaSystemRole role = new FlxoaSystemRole();
		model.setId(Integer.valueOf(request.getParameter("roleid")));
		FlxoaSystemRole flxoaSystemRole = flxoaSystemRoleService.queryById(model);
		boolean b = flxoaSystemRoleService.delete(flxoaSystemRole);
		String result = "0";
		if (b) {
			result = "1";
		}
		return result;
	}
	
	
	
	
	/**
	 * @param request
	 * @param response
	 * @param model
	 * @return 角色信息
	 */
//	@RequestMapping(value = "/flxoaSystemRoleParticulars", produces = "text/html;charset=utf-8")
//	@ResponseBody
//	public String  flxoaSystemRoleParticulars(HttpServletRequest request,
//			HttpServletResponse response, FlxoaSystemRoleFuncation model){
//		// newjson對象
//		JSONArray json = new JSONArray();
//		// newMap集合存放返回前台页面的json
//		Map<String, List> map = new HashMap<String, List>();
//		model.setRoleId(2);
//		List<FlxoaSystemRoleFuncation> role = flxoaSystemRoleFuncationService.query(model);
//		map.put("particularsmessage", role);
//		JSONArray jsonMap = json.put(map);
//		return json.toString();
//	}
	
	/**
	 * @param request
	 * @param response
	 * @param model
	 * @return 角色管理-操作-查看
	 */
	@RequestMapping(value = "/flxoaSystemRoleFuncation", produces = "text/html;charset=utf-8")
	@ResponseBody
	public String flxoaSystemRoleFuncation(HttpServletRequest request,
			HttpServletResponse response, FlxoaSystemRoleFuncation model){
		model.setRoleId(Integer.parseInt(request.getParameter("roleId")));
		JSONArray json = new JSONArray();
		//newMap集合存放返回前台页面的json
		Map<String, List> map = new HashMap<String, List>();
		//通过表关联查询“用户表”“角色表”“部门表”获取数据
		List<FlxoaSystemRoleFuncation> role = flxoaSystemRoleFuncationService.query(model);
		map.put("rolefunmessage", role);
		JSONArray jsonMap = json.put(map);
		return json.toString();
	}
}
